<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T-Mobile — Customer Happiness Dashboard</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f1720; --panel:#0b1220; --muted:#9aa4b2; --accent:#00a8ff;
      --good:#16a34a; --bad:#ef4444; --card-radius:12px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#061224 0%, #071026 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
    .container{max-width:1200px;margin:24px auto;padding:20px;color:#e6eef8;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:var(--panel);border-radius:var(--card-radius);padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);overflow:hidden}
    .table-wrap{max-height:560px;overflow:auto;border-radius:8px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:rgba(7,14,22,0.9);color:var(--muted);text-align:left;padding:10px 12px;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.03)}
    tbody tr{border-bottom:1px solid rgba(255,255,255,0.03)}
    td{padding:10px 12px;color:#dbeafe}
    tr:hover td{background:rgba(255,255,255,0.02)}
    .tiny{font-size:12px;color:var(--muted)}
    .right{text-align:right}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .good{background:rgba(22,163,74,0.12);color:var(--good)} 
    .warn{background:rgba(250,204,21,0.12);color:#f59e0b} 
    .bad{background:rgba(239,68,68,0.12);color:var(--bad)}
    .chart-wrap{height:260px}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    .meta{display:flex;gap:12px;align-items:center}
    .refresh-btn{background:#071a2b;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>T-Mobile Customer Happiness Dashboard</h1>
        <div class="subtitle">Real-time network table (1 min) • Daily Happiness Index (midnight)</div>
      </div>
      <div class="meta">
        <div class="small" id="last-network">Network updated: —</div>
        <div class="small" id="last-happy">Happiness last date: —</div>
        <button class="refresh-btn" id="manual-refresh">Refresh Now</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Task-Manager-style table -->
      <div class="card">
        <h3 style="margin:0 0 10px 0">Network Performance — Towers</h3>
        <div class="table-wrap" id="network-table-wrap">
          <table id="network-table">
            <thead>
              <tr>
                <th>Tower / Market</th>
                <th class="right">Latency (ms)</th>
                <th class="right">Packet Loss (%)</th>
                <th class="right">Outage Rate</th>
                <th class="right">Load (%)</th>
                <th class="right">Sessions</th>
              </tr>
            </thead>
            <tbody id="network-body"></tbody>
          </table>
        </div>
        <footer>
          <div class="small">Showing latest snapshot for each tower. Table refreshes every minute.</div>
        </footer>
      </div>

      <!-- Right: Happiness chart -->
      <div class="card">
        <h3 style="margin:0 0 10px 0">Overall Customer Happiness Index — Daily</h3>
        <div class="chart-wrap">
          <canvas id="happinessChart" width="400" height="260"></canvas>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:10px;align-items:center">
          <div class="tiny" id="today-index">Today's index: —</div>
          <div>
            <button class="refresh-btn" id="refresh-chart">Refresh Chart</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Point to backend API. If you open this page from file://, use absolute URL with 127.0.0.1 to avoid host mismatches.
const NETWORK_ENDPOINT = 'http://127.0.0.1:4000/network_metrics.json';
const HAPPINESS_CSV_ENDPOINT = 'http://127.0.0.1:4000/daily_happiness.csv';
const NETWORK_REFRESH_MS = 60 * 1000; // 1 min
const HAPPINESS_REFRESH_MS = 24 * 60 * 60 * 1000; // daily

// Preset configuration for chart seeding
const PRESET_DAYS = 90;
const TM_MAGENTA = '#e20074';
const SEED_KEY = 'happySeed';

const networkBody = document.getElementById('network-body');
const lastNetwork = document.getElementById('last-network');
const lastHappy = document.getElementById('last-happy');
const manualRefreshBtn = document.getElementById('manual-refresh');
const refreshChartBtn = document.getElementById('refresh-chart');
const todayIndexEl = document.getElementById('today-index');

let happinessChart = null;
function fmt(n,d=2){return(n===null||n===undefined)?'—':Number(n).toFixed(d);}

async function loadNetworkMetrics(){
  try{
    const res = await fetch(NETWORK_ENDPOINT + '?_ts=' + Date.now());
    if(!res.ok) throw new Error(res.status);
    const data = await res.json();
    data.sort((a,b) => (b.network_load_percent||0)-(a.network_load_percent||0));
    networkBody.innerHTML='';
    data.slice(0,500).forEach(r=>{
      let outage = r.outage_rate_pct<=1?r.outage_rate_pct*100:r.outage_rate_pct;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><strong>${escapeHtml(r.tower_id||r.market_id||'—')}</strong><div class="tiny">${escapeHtml(r.location||'')}</div></td>
        <td class="right">${fmt(r.avg_latency_ms||r.latencyMs||0,0)}</td>
        <td class="right">${fmt(r.avg_packet_loss_pct||r.packet_loss_pct||0,2)}</td>
        <td class="right">${fmt(outage,2)}%</td>
        <td class="right">${fmt(r.network_load_percent||0,0)}%</td>
        <td class="right">${fmt(r.active_sessions||0,0)}</td>
      `;
      const lat = Number(r.avg_latency_ms||0);
      const pkt = Number(r.avg_packet_loss_pct||0);
      if(lat>120||pkt>2) tr.classList.add('bad');
      else if(lat>80||pkt>1) tr.classList.add('warn');
      else tr.classList.add('good');
      networkBody.appendChild(tr);
    });
    lastNetwork.textContent='Network updated: '+new Date().toLocaleString();
  }catch(err){console.error(err); lastNetwork.textContent='Network updated: (error)';}
}

async function loadHappinessCSV(){
  try{
    const res = await fetch(HAPPINESS_CSV_ENDPOINT + '?_ts=' + Date.now());
    if(!res.ok) throw new Error(res.status);
    const txt = await res.text();
    const lines = txt.trim().split('\n').filter(Boolean);
    // Parse CSV (if any)
    let csvPoints = [];
    if(lines.length>1){
      const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
      const rows = lines.slice(1).map(l=>{
        const cols = l.split(',');
        const obj={};
        header.forEach((h,i)=>obj[h]=cols[i]?cols[i].trim():'');
        return obj;
      });
      csvPoints = rows.map(r=>{
        const dateLabel=r.date||Object.values(r)[0];
        const val=parseFloat(r.customer_happiness_index||Object.values(r)[1])||0;
        return {date:dateLabel,value:val};
      });
    }

    // Build seeded series with PRESET_DAYS window merged with CSV (CSV overrides seed on same day)
    const points = buildSeededSeries(csvPoints, PRESET_DAYS);
    updateHappinessChart(points);
    lastHappy.textContent='Happiness last date: '+(points.length?points[points.length-1].date:'—');
    todayIndexEl.textContent="Today's index: "+(points.length?points[points.length-1].value:'—');
  }catch(err){console.error(err); lastHappy.textContent='Happiness last date: (error)';}
}

function updateHappinessChart(points){
  const ctx=document.getElementById('happinessChart').getContext('2d');
  const labels=points.map(p=>p.date);
  const data=points.map(p=>p.value);
  if(happinessChart){
    happinessChart.data.labels=labels;
    happinessChart.data.datasets[0].data=data;
    happinessChart.update(); return;
  }
  happinessChart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[{label:'Customer Happiness Index',data,borderColor:TM_MAGENTA,backgroundColor:'rgba(226,0,116,0.15)',tension:0.3,fill:true,pointRadius:0,borderWidth:2}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{
        x:{ticks:{color:'#f2cfe0'},grid:{color:'rgba(226,0,116,0.08)'}},
        y:{beginAtZero:true,ticks:{color:'#f2cfe0'},grid:{color:'rgba(226,0,116,0.08)'}}
      },
      plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,backgroundColor:'#0b1220',titleColor:'#e6eef8',bodyColor:'#e6eef8'}}
    }
  });
}

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);}

document.addEventListener('DOMContentLoaded',()=>{
  loadNetworkMetrics();
  loadHappinessCSV();
  setInterval(loadNetworkMetrics,NETWORK_REFRESH_MS);
  setInterval(loadHappinessCSV,HAPPINESS_REFRESH_MS);
  manualRefreshBtn.addEventListener('click',()=>{loadNetworkMetrics(); loadHappinessCSV();});
  refreshChartBtn.addEventListener('click',()=>loadHappinessCSV());
  // Schedule an append at midnight to keep the chart lively even without backend daily aggregates
  scheduleMidnightAppend();
});

// ----- Seeding helpers -----
function buildSeededSeries(csvPoints, days){
  // Build last N dates (YYYY-MM-DD)
  const dates = lastNDates(days);
  // Load existing seed from localStorage
  let seed = [];
  try{ seed = JSON.parse(localStorage.getItem(SEED_KEY)||'[]'); }catch(_){ seed = []; }
  const seedMap = new Map(seed.map(p=>[p.date, Number(p.value)||0]));
  // CSV overrides seed on same day
  const csvMap = new Map((csvPoints||[]).map(p=>[p.date, Number(p.value)||0]));
  // Ensure we have a value for each date; generate random when missing
  const out = dates.map(d=>{
    const v = csvMap.has(d) ? csvMap.get(d) : (seedMap.has(d) ? seedMap.get(d) : Math.round(Math.random()*100));
    return {date:d, value:v};
  });
  // Save merged seed back (only dates window)
  try{ localStorage.setItem(SEED_KEY, JSON.stringify(out)); }catch(_){ }
  return out;
}

function lastNDates(n){
  const arr=[]; const today=new Date();
  for(let i=n-1;i>=0;i--){ const d=new Date(today); d.setDate(d.getDate()-i); arr.push(fmtDate(d)); }
  return arr;
}

function fmtDate(d){
  const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function scheduleMidnightAppend(){
  const now=new Date();
  const next=new Date(now);
  next.setHours(24,0,0,0); // next midnight
  const wait=next-now;
  setTimeout(()=>{ appendDailyPoint(); scheduleMidnightAppend(); }, wait);
}

function appendDailyPoint(){
  let seed=[]; try{ seed=JSON.parse(localStorage.getItem(SEED_KEY)||'[]'); }catch(_){ seed=[]; }
  const todayStr = fmtDate(new Date());
  // If today's point exists, skip; else append a new random value and slide window
  const exists = seed.some(p=>p.date===todayStr);
  if(!exists){
    seed.push({date: todayStr, value: Math.round(Math.random()*100)});
  }
  // Keep only last PRESET_DAYS
  if(seed.length>PRESET_DAYS) seed = seed.slice(seed.length-PRESET_DAYS);
  try{ localStorage.setItem(SEED_KEY, JSON.stringify(seed)); }catch(_){ }
  // Update chart if present
  if(happinessChart){
    const labels = seed.map(p=>p.date);
    const data = seed.map(p=>p.value);
    happinessChart.data.labels=labels;
    happinessChart.data.datasets[0].data=data;
    happinessChart.update();
    lastHappy.textContent='Happiness last date: '+(labels[labels.length-1]||'—');
    todayIndexEl.textContent="Today's index: "+(data[data.length-1]??'—');
  }
}
</script>
</body>
</html>
